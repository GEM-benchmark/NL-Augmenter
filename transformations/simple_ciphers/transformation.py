import codecs
import itertools
import random

from interfaces.SentenceOperation import SentenceOperation
from tasks.TaskTypes import TaskType

"""
Base Class for implementing the different input transformations a generation should be robust against.
"""


rot13 = lambda s : codecs.getencoder("rot-13")(s)[0]
def reverse_each_word(sentence):
  words = sentence.split(" ")
  newWords = [word[::-1] for word in words]
  return " ".join(newWords)
def reverse_characters(sentence):
  return sentence[::-1]
def reverse_words(sentence):
  words = sentence.split(" ")
  return " ".join(words[::-1])
def double_words(sentence):
  words = sentence.split(" ")
  newWords = [f"{word} {word}" for word in words]
  return " ".join(newWords)
def double_characters(sentence):
  return "".join([f"{character}{character}" for character in sentence])
def space_characters(sentence):
  return " ".join([character for character in sentence])

# Homoglyph list taken from https://github.com/codebox/homoglyph/
# released under an MIT License https://github.com/codebox/homoglyph/blob/master/LICENSE
homoglyphs = {
    "a":"AÎ‘Ğáªá—…á´€ê“®ê­ºï¼¡ğŠ ğ–½€ğ€ğ´ğ‘¨ğ’œğ“ğ”„ğ”¸ğ•¬ğ– ğ—”ğ˜ˆğ˜¼ğ™°ğš¨ğ›¢ğœœğ–ğaÉ‘Î±Ğ°âºï½ğšğ‘ğ’‚ğ’¶ğ“ªğ”ğ•’ğ–†ğ–ºğ—®ğ˜¢ğ™–ğšŠğ›‚ğ›¼ğœ¶ğ°ğª",
    "b":"BÊ™Î’Ğ’Ğ²á´á¼á—·á›’â„¬ê“ê´ï¼¢ğŠ‚ğŠ¡ğŒğğµğ‘©ğ“‘ğ”…ğ”¹ğ•­ğ–¡ğ—•ğ˜‰ğ˜½ğ™±ğš©ğ›£ğœğ—ğ‘bÆ„Ğ¬áá‘²á–¯ï½‚ğ›ğ‘ğ’ƒğ’·ğ“«ğ”Ÿğ•“ğ–‡ğ–»ğ—¯ğ˜£ğ™—ğš‹",
    "c":"CÏ¹Ğ¡áŸá‘•â„‚â„­â…­âŠ‚â²¤â¸¦ê“šï¼£ğŠ¢ğŒ‚ğ•ğ”œğ‘£©ğ‘£²ğ‚ğ¶ğ‘ªğ’ğ“’ğ•®ğ–¢ğ—–ğ˜Šğ˜¾ğ™²ğŸŒcÏ²Ñá´„â…½â²¥ê®¯ï½ƒğ½ğœğ‘ğ’„ğ’¸ğ“¬ğ” ğ•”ğ–ˆğ–¼ğ—°ğ˜¤ğ™˜ğšŒ",
    "d":"Dá á—á—ªá´…â……â…®ê““ê­°ï¼¤ğƒğ·ğ‘«ğ’Ÿğ““ğ”‡ğ”»ğ•¯ğ–£ğ——ğ˜‹ğ˜¿ğ™³dÔá§á‘¯â…†â…¾ê“’ï½„ğğ‘‘ğ’…ğ’¹ğ“­ğ”¡ğ••ğ–‰ğ–½ğ—±ğ˜¥ğ™™ğš",
    "e":"EÎ•Ğ•á¬á´‡â„°â‹¿â´¹ê“°ê­¼ï¼¥ğŠ†ğ‘¢¦ğ‘¢®ğ„ğ¸ğ‘¬ğ“”ğ”ˆğ”¼ğ•°ğ–¤ğ—˜ğ˜Œğ™€ğ™´ğš¬ğ›¦ğœ ğšğ”eĞµÒ½â„®â„¯â…‡",
    "f":"FÏœá–´â„±ê“ğŠ‡ğŠ¥ğ”¥ğ‘¢¢ğ‘£‚fÅ¿ÏÖ„áº",
    "g":"GÉ¢ÔŒÔá€á³á»ê“–ê®ï¼§ğ†ğºğ‘®ğ’¢ğ“–ğ”Šğ”¾ğ•²ğ–¦ğ—šğ˜ğ™‚ğ™¶gÆÉ¡Öá¶ƒâ„Šï½‡ğ ğ‘”ğ’ˆğ“°ğ”¤ğ•˜ğ–Œğ—€ğ—´ğ˜¨ğ™œğš",
    "h":"HÊœÎ—ĞĞ½á»á•¼â„‹â„Œâ„â²ê“§ê®‹ï¼¨ğ‹ğ‡ğ»ğ‘¯ğ“—ğ•³ğ–§ğ—›ğ˜ğ™ƒğ™·ğš®ğ›¨ğœ¢ğœğ–hÒ»Õ°á‚â„ï½ˆğ¡ğ’‰ğ’½ğ“±ğ”¥ğ•™ğ–ğ—ğ—µğ˜©ğ™ğš‘",
    "i":"1Il|Æ–Ç€Î™Ğ†Ó€×€×•×ŸØ§Ù¡Û±ßŠá›â„â„‘â„“â… â…¼âˆ£â½â²’âµê“²ïºïºï¼‘ï¼©ï½Œï¿¨ğŠŠğŒ‰ğŒ ğ–¼¨ğˆğ¥ğ¼ğ‘™ğ‘°ğ’ğ“ğ“˜ğ“µğ”©ğ•€ğ•ğ•´ğ–‘ğ–¨ğ—…ğ—œğ—¹ğ˜ğ˜­ğ™„ğ™¡ğ™¸ğš•ğš°ğ›ªğœ¤ğğ˜ğŸğŸ™ğŸ£ğŸ­ğŸ·ğ£‡Ä±É©ÉªË›ÍºÎ¹Ñ–Óá¥á¾¾â„¹â…ˆâ…°â³ê™‡ê­µï½‰ğ‘£ƒğ¢ğ‘–ğ’Šğ’¾ğ“²ğ”¦ğ•šğ–ğ—‚ğ—¶ğ˜ªğ™ğš’ğš¤ğ›Šğœ„ğœ¾ğ¸ğ²",
    "j":"JÍ¿Ğˆá«á’á´Šê“™ê­»ï¼ªğ‰ğ½ğ‘±ğ’¥ğ“™ğ”ğ•ğ•µğ–©ğ—ğ˜‘ğ™…ğ™¹jÏ³Ñ˜â…‰ï½Šğ£ğ‘—ğ’‹ğ’¿ğ“³ğ”§ğ•›ğ–ğ—ƒğ—·ğ˜«ğ™Ÿğš“",
    "k":"KÎšĞšá¦á›•â„ªâ²”ê“—ï¼«ğ”˜ğŠğ¾ğ‘²ğ’¦ğ“šğ”ğ•‚ğ•¶ğ–ªğ—ğ˜’ğ™†ğ™ºğš±ğ›«ğœ¥ğŸğ™kï½‹ğ¤ğ‘˜ğ’Œğ“€ğ“´ğ”¨ğ•œğ–ğ—„ğ—¸ğ˜¬ğ™ ğš”",
    "l":"LÊŸáá’ªâ„’â…¬â³â³‘ê“¡ê®®ï¼¬ğ›ğ‘ƒğ”¦ğ‘¢£ğ‘¢²ğ–¼–",
    "m":"MÎœÏºĞœá·á—°á›–â„³â…¯â²˜ê“Ÿï¼­ğŠ°ğŒ‘ğŒğ‘€ğ‘´ğ“œğ”ğ•„ğ•¸ğ–¬ğ— ğ˜”ğ™ˆğ™¼ğš³ğ›­ğœ§ğ¡ğ›mï½",
    "n":"NÉ´Îâ„•â²šê“ ï¼®ğ”“ğğ‘ğ‘µğ’©ğ“ğ”‘ğ•¹ğ–­ğ—¡ğ˜•ğ™‰ğ™½ğš´ğ›®ğœ¨ğ¢ğœnÕ¸Õ¼ï½ğ§ğ‘›ğ’ğ“ƒğ“·ğ”«ğ•Ÿğ–“ğ—‡ğ—»ğ˜¯ğ™£ğš—",
    "o":"0OoÎŸÎ¿ÏƒĞĞ¾Õ•Ö…×¡Ù‡Ù¥Ú¾ÛÛ•Ûµß€à¥¦à§¦à©¦à«¦à¬ à­¦à¯¦à°‚à±¦à²‚à³¦à´‚à´ àµ¦à¶‚à¹à»á€á€áƒ¿á‹á´á´‘â„´â²â²Ÿâµ”ã€‡ê“³ï®¦ï®§ï®¨ï®©ï®ªï®«ï®¬ï®­ï»©ï»ªï»«ï»¬ï¼ï¼¯ï½ğŠ’ğŠ«ğ„ğ¬ğ“‚ğ“ªğ”–ğ‘“ğ‘¢µğ‘£ˆğ‘£—ğ‘£ ğğ¨ğ‘‚ğ‘œğ‘¶ğ’ğ’ªğ“ğ“¸ğ”’ğ”¬ğ•†ğ• ğ•ºğ–”ğ–®ğ—ˆğ—¢ğ—¼ğ˜–ğ˜°ğ™Šğ™¤ğ™¾ğš˜ğš¶ğ›ğ›”ğ›°ğœŠğœğœªğ„ğˆğ¤ğ¾ğ‚ğğ¸ğ¼ğŸğŸ˜ğŸ¢ğŸ¬ğŸ¶",
    "p":"PÎ¡Ğ á¢á‘­á´˜á´©â„™â²¢ê“‘ê®²ï¼°ğŠ•ğğ‘ƒğ‘·ğ’«ğ“Ÿğ”“ğ•»ğ–¯ğ—£ğ˜—ğ™‹ğ™¿ğš¸ğ›²ğœ¬ğ¦ğ pÏÏ±Ñ€â´â²£ï½ğ©ğ‘ğ’‘ğ“…ğ“¹ğ”­ğ•¡ğ–•ğ—‰ğ—½ğ˜±ğ™¥ğš™ğ›’ğ› ğœŒğœšğ†ğ”ğ€ğğºğŸˆ",
    "q":"Qâ„šâµ•ï¼±ğğ‘„ğ‘¸ğ’¬ğ“ ğ””ğ•¼ğ–°ğ—¤ğ˜˜ğ™Œğš€qÔ›Õ£Õ¦ï½‘ğªğ‘ğ’’ğ“†ğ“ºğ”®ğ•¢ğ––ğ—Šğ—¾ğ˜²ğ™¦ğšš",
    "r":"RÆ¦Ê€á¡á’á–‡áš±â„›â„œâ„ê“£ê­±ê®¢ï¼²ğ’´ğ–¼µrĞ³á´¦â²…ê®ï½’ğ«ğ‘Ÿğ’“ğ“‡ğ“»ğ”¯ğ•£ğ–—ğ—‹ğ—¿ğ˜³ğ™§ğš›",
    "s":"SĞ…Õá•ášê“¢ï¼³ğŠ–ğ ğ–¼ºğ’ğ‘†ğ‘ºğ’®ğ“¢ğ”–ğ•Šğ•¾ğ–²ğ—¦ğ˜šğ™ğš‚sÆ½Ñ•êœ±ê®ªï½“ğ‘ˆğ‘£ğ¬ğ‘ ğ’”ğ“ˆğ“¼ğ”°ğ•¤ğ–˜ğ—Œğ˜€ğ˜´ğ™¨ğšœ",
    "t":"TÎ¤Ï„Ğ¢Ñ‚á¢á´›âŠ¤âŸ™â²¦ê“”ê­²ï¼´ğŠ—ğŠ±ğŒ•ğ‘¢¼ğ–¼Šğ“ğ‘‡ğ‘»ğ’¯ğ“£ğ”—ğ•‹ğ•¿ğ–³ğ—§ğ˜›ğ™ğšƒğš»ğ›•ğ›µğœğœ¯ğ‰ğ©ğƒğ£ğ½ğŸ¨tï½”ğ­ğ‘¡ğ’•ğ“‰ğ“½ğ”±ğ•¥ğ–™ğ—ğ˜ğ˜µğ™©ğš",
    "u":"UÕáˆ€á‘Œâˆªâ‹ƒê“´ï¼µğ“ğ‘¢¸ğ–½‚ğ”ğ‘ˆğ‘¼ğ’°ğ“¤ğ”˜ğ•Œğ–€ğ–´ğ—¨ğ˜œğ™ğš„uÊ‹Ï…Õ½á´œğ“¶ğ‘£˜ğ®ğ‘¢ğ’–ğ“Šğ“¾ğ”²ğ•¦ğ–šğ—ğ˜‚ğ˜¶ğ™ªğšğ›–ğœğŠğ„ğ¾",
    "v":"VÑ´Ù§Û·á™á¯â…¤â´¸ê“¦ê›Ÿï¼¶ğ”ğ‘¢ ğ–¼ˆvÎ½Ñµ×˜á´ â…´âˆ¨â‹ê®©ï½–ğ‘œ†ğ‘£€ğ¯ğ‘£ğ’—ğ“‹ğ“¿ğ”³ğ•§ğ–›ğ—ğ˜ƒğ˜·ğ™«ğšŸğ›ğœˆğ‚ğ¼ğ¶",
    "w":"WÔœá³á”ê“ªï¼·ğ‘£¦ğ‘£¯ğ–ğ‘Šğ‘¾ğ’²ğ“¦ğ”šğ•ğ–‚ğ–¶ğ—ªğ˜ğ™’ğš†wÉ¯Ñ¡ÔÕ¡á´¡ê®ƒï½—ğ‘œŠğ‘œğ‘œğ°ğ‘¤ğ’˜ğ“Œğ”€ğ”´ğ•¨ğ–œğ—ğ˜„ğ˜¸ğ™¬ğš ",
    "x":"XÎ§Ğ¥á™­áš·â…©â•³â²¬âµê“«ğŠğŠ´ğŒ—ğŒ¢ğ”§ğ‘£¬ğ—ğ‘‹ğ‘¿ğ’³ğ“§ğ”›ğ•ğ–ƒğ–·ğ—«ğ˜Ÿğ™“ğš‡ğš¾ğ›¸ğœ²ğ¬ğ¦xÃ—Ñ…á•á•½á™®â…¹â¤«â¤¬â¨¯ï½˜ğ±ğ‘¥ğ’™ğ“ğ”ğ”µğ•©ğ–ğ—‘ğ˜…ğ˜¹ğ™­ğš¡",
    "y":"YÎ¥Ï’Ğ£Ò®á©á½â²¨ê“¬ï¼¹ğŠ²ğ‘¢¤ğ–½ƒğ˜ğ‘Œğ’€ğ’´ğ“¨ğ”œğ•ğ–„ğ–¸ğ—¬ğ˜ ğ™”ğšˆğš¼ğ›¶ğœ°ğªğ¤yÉ£ÊÎ³ÑƒÒ¯áƒ§á¶Œá»¿â„½ğ‘£œğ²ğ‘¦ğ’šğ“ğ”‚ğ”¶ğ•ªğ–ğ—’ğ˜†ğ˜ºğ™®ğš¢ğ›„ğ›¾ğœ¸ğ²ğ¬",
    "z":"ZÎ–áƒâ„¤â„¨ê“œï¼ºğ‹µğ‘¢©ğ‘£¥ğ™ğ‘ğ’ğ’µğ“©ğ–…ğ–¹ğ—­ğ˜¡ğ™•ğš‰ğš­ğ›§ğœ¡ğ›ğ•zá´¢ê®“ï½šğ‘£„ğ³ğ‘§ğ’›ğ“ğ”ƒğ”·ğ•«ğ–Ÿğ—“ğ˜‡ğ˜»ğ™¯ğš£",
    "'":"'`Â´Ê¹Ê»Ê¼Ê½Ê¾ËˆËŠË‹Ë´Í´Î„ÕšÕ×™×³ß´ßµá‘Šá›Œá¾½á¾¿á¿¯á¿½á¿¾â€˜â€™â€›â€²â€µêŒï¼‡ï½€",
    "\"":"'`Â´Ê¹Ê»Ê¼Ê½Ê¾ËˆËŠË‹Ë´Í´Î„ÕšÕ×™×³ß´ßµá‘Šá›Œá¾½á¾¿á¿¯á¿½á¿¾â€˜â€™â€›â€²â€µêŒï¼‡ï½€",
    "?":"?ÉÊ”à¥½á®ê›«ï¼Ÿ",
    ".":".Ù Û°ÜÜ‚â€¤ê“¸ê˜ï¼ğ©",
    "!":"!Çƒâµ‘ï¼",
    ",":",Â¸ØÙ«â€šê“¹ï¼Œ",
    "0":"0OoÎŸÎ¿ÏƒĞĞ¾Õ•Ö…×¡Ù‡Ù¥Ú¾ÛÛ•Ûµß€à¥¦à§¦à©¦à«¦à¬ à­¦à¯¦à°‚à±¦à²‚à³¦à´‚à´ àµ¦à¶‚à¹à»á€á€áƒ¿á‹á´á´‘â„´â²â²Ÿâµ”ã€‡ê“³ê¬½ï®¦ï®§ï®¨ï®©ï®ªï®«ï®¬ï®­ï»©ï»ªï»«ï»¬ï¼ï¼¯ï½ğŠ’ğŠ«ğ„ğ¬ğ“‚ğ“ªğ”–ğ‘“ğ‘¢µğ‘£ˆğ‘£—ğ‘£ ğğ¨ğ‘‚ğ‘œğ‘¶ğ’ğ’ªğ“ğ“¸ğ”’ğ”¬ğ•†ğ• ğ•ºğ–”ğ–®ğ—ˆğ—¢ğ—¼ğ˜–ğ˜°ğ™Šğ™¤ğ™¾ğš˜ğš¶ğ›ğ›”ğ›°ğœŠğœğœªğ„ğˆğ¤ğ¾ğ‚ğğ¸ğ¼ğŸğŸ˜ğŸ¢ğŸ¬ğŸ¶ğ¸¤ğ¹¤ğº„ğŸ¯°",
    "1":"1Il|Æ–Ç€Î™Ğ†Ó€×€×•×ŸØ§Ù¡Û±ßŠá›â„â„‘â„“â… â…¼âˆ£â½â²’âµê“²ïºïºï¼‘ï¼©ï½Œï¿¨ğŠŠğŒ‰ğŒ ğ–¼¨ğˆğ¥ğ¼ğ‘™ğ‘°ğ’ğ“ğ“˜ğ“µğ”©ğ•€ğ•ğ•´ğ–‘ğ–¨ğ—…ğ—œğ—¹ğ˜ğ˜­ğ™„ğ™¡ğ™¸ğš•ğš°ğ›ªğœ¤ğğ˜ğŸğŸ™ğŸ£ğŸ­ğŸ·ğ£‡ğ¸€ğº€ğŸ¯±",
    "2":"2Æ§Ï¨á’¿ê™„ê›¯êšï¼’ğŸğŸšğŸ¤ğŸ®ğŸ¸",
    "3":"3Æ·ÈœĞ—Ó â³Œêªğ‘£Šğ–¼»",
    "4":"4áï¼”ğ‘¢¯ğŸ’ğŸœğŸ¦ğŸ°ğŸº",
    "5":"5Æ¼ï¼•ğ‘¢»ğŸ“ğŸğŸ§ğŸ±ğŸ»",
    "6":"6Ğ±á®â³’ï¼–ğ‘£•ğŸ”ğŸğŸ¨ğŸ²ğŸ¼",
    "7":"7ï¼—ğ“’ğ‘£†",
    "8":"8È¢È£à§ªà©ªà¬ƒï¼˜ğŒšğŸ–ğŸ ğŸªğŸ´ğŸ¾ğ£‹",
    "9":"9à§­à©§à­¨àµ­â³Šê®ï¼™ğ‘¢¬ğ‘£Œğ‘£–ğŸ—ğŸ¡ğŸ«ğŸµğŸ¿",
}
def substitute_homoglyphs(sentence):
  newSentence = ""
  for character in sentence:
    lc = character.lower()
    if lc in homoglyphs:
      newSentence += random.choice(homoglyphs[lc])
    else:
      newSentence += character
  return newSentence

class SimpleCiphers(SentenceOperation):
  """
  Simple transformations of the input text that a human could rapidly (or with
  a few minutes of work in the case of rot13) decipher, but which make the
  input sequences almost completely unlike most of the data a language model is
  likely trained on.
  """

  def __init__(self, seed=0, max_outputs=8):
    random.seed(seed)
    super().__init__(seed, max_outputs=max_outputs)

  
  tasks = [TaskType.TEXT_CLASSIFICATION, TaskType.TEXT_TO_TEXT_GENERATION]
  languages = ["en"]
  
  def generate(self, sentence):
    return [
            double_characters(sentence),
            double_words(sentence),
            space_characters(sentence),
            reverse_characters(sentence),
            reverse_each_word(sentence),
            reverse_words(sentence),
            substitute_homoglyphs(sentence),
            rot13(sentence)]


"""
# Sample code to demonstrate usage. Can also assist in adding test cases.
# You don't need to keep this code in your transformation.
if __name__ == '__main__':
    import json
    from TestRunner import convert_to_snake_case

    tf = SimpleCiphers(max_outputs=20)
    test_cases = []
    for sentence in ["The red fox jumped over the lazy dog."]:
        test_cases.append({
            "class": tf.name(),
            "inputs": {"sentence": sentence}, "outputs": [{"sentence": o} for o in tf.generate(sentence)]}
        )
    json_file = {"type": convert_to_snake_case(tf.name()), "test_cases": test_cases}
    print(json.dumps(json_file, indent=2))
"""
