import itertools
import json
import os
import random
import re

from nltk import download as nltkdl
from nltk.corpus import stopwords
from nltk.tokenize import word_tokenize

from interfaces.SentenceOperation import SentenceOperation
from tasks.TaskTypes import TaskType


def font_change(sentence, fonts, seed=666, max_outputs=1):
    random.seed(seed)
    perturbed_texts = []

    for _ in itertools.repeat(None, max_outputs):
        # Generate the sentence with random fonts
        tokens_escaped_list = []
        for token in word_tokenize(sentence):
            if token not in stopwords.words("english"):
                if token != ".":
                    tokens_escaped_list.extend(
                        list(re.finditer(re.escape(token), sentence))
                    )

        transformed_sentence = list(sentence)

        tokens_to_change = random.sample(
            tokens_escaped_list,
            random.randint(1, min(3, len(tokens_escaped_list) - 1)),
        )
        for ttc in tokens_to_change:
            while True:
                font = random.sample(list(fonts.keys()), 1)[0]
                if font != "normal":
                    break

            for i in range(ttc.start(), ttc.end()):
                try:
                    transformed_sentence[i] = fonts[font][
                        transformed_sentence[i]
                    ]
                except KeyError:
                    transformed_sentence[i] = transformed_sentence[i]

        perturbed_texts.append("".join(transformed_sentence))
    return perturbed_texts


class FontChange(SentenceOperation):
    tasks = [
        TaskType.TEXT_CLASSIFICATION,
        TaskType.TEXT_TAGGING,
    ]
    languages = [
        "aa",
        "aai",
        "aak",
        "aau",
        "abi",
        "abr",
        "abt",
        "aby",
        "acd",
        "ace",
        "ach",
        "ada",
        "ade",
        "adj",
        "adz",
        "aey",
        "af",
        "agc",
        "agd",
        "agg",
        "agm",
        "ago",
        "agq",
        "aha",
        "ahl",
        "ajg",
        "ak",
        "ala",
        "ali",
        "aln",
        "amm",
        "amn",
        "amo",
        "amp",
        "an",
        "anc",
        "ank",
        "ann",
        "any",
        "aoj",
        "aom",
        "aoz",
        "ape",
        "apr",
        "aps",
        "apz",
        "arh",
        "arn",
        "aro",
        "asa",
        "asg",
        "aso",
        "ast",
        "ata",
        "atg",
        "atj",
        "auy",
        "avn",
        "avt",
        "avu",
        "awb",
        "awo",
        "awx",
        "ay",
        "ayb",
        "az",
        "ban",
        "bar",
        "bas",
        "bav",
        "bba",
        "bbb",
        "bbc",
        "bbd",
        "bbj",
        "bbp",
        "bbr",
        "bcf",
        "bch",
        "bci",
        "bcm",
        "bcn",
        "bco",
        "bcu",
        "bdd",
        "bef",
        "beh",
        "bem",
        "bet",
        "bew",
        "bex",
        "bez",
        "bfd",
        "bhg",
        "bhl",
        "bhy",
        "bi",
        "bib",
        "big",
        "bik",
        "bim",
        "bin",
        "bio",
        "biq",
        "bjh",
        "bjn",
        "bjo",
        "bjr",
        "bjt",
        "bjz",
        "bkc",
        "bkm",
        "bkq",
        "bku",
        "bkv",
        "bm",
        "bmh",
        "bmk",
        "bmq",
        "bmu",
        "bng",
        "bnm",
        "bnp",
        "boj",
        "bom",
        "bon",
        "bqc",
        "bqp",
        "bqv",
        "br",
        "brz",
        "bs",
        "bsj",
        "bss",
        "bto",
        "btt",
        "buc",
        "bud",
        "bug",
        "buk",
        "bum",
        "buo",
        "bus",
        "buu",
        "bvb",
        "bwd",
        "bwr",
        "bxh",
        "bye",
        "byr",
        "bys",
        "byv",
        "byx",
        "bza",
        "bze",
        "bzf",
        "bzh",
        "bzw",
        "ca",
        "cad",
        "can",
        "cbj",
        "cch",
        "ceb",
        "cfa",
        "cgg",
        "ch",
        "chk",
        "cho",
        "chp",
        "cic",
        "cjv",
        "ckl",
        "cko",
        "cky",
        "cla",
        "cme",
        "co",
        "cps",
        "crs",
        "cs",
        "csb",
        "cy",
        "da",
        "dad",
        "daf",
        "dag",
        "dah",
        "dak",
        "dav",
        "dbd",
        "dbq",
        "ddn",
        "de",
        "ded",
        "den",
        "dga",
        "dgh",
        "dgi",
        "dgr",
        "dgz",
        "dia",
        "dje",
        "dnj",
        "dob",
        "dop",
        "dow",
        "dri",
        "dsb",
        "dtm",
        "dtp",
        "dts",
        "dua",
        "duc",
        "dud",
        "dug",
        "dva",
        "dww",
        "dyo",
        "dyu",
        "dzg",
        "ebu",
        "ee",
        "efi",
        "egl",
        "eka",
        "ema",
        "emi",
        "en",
        "enn",
        "enq",
        "eo",
        "eri",
        "es",
        "esu",
        "et",
        "etr",
        "etu",
        "etx",
        "eu",
        "ewo",
        "ext",
        "faa",
        "fab",
        "fag",
        "fai",
        "fan",
        "ff",
        "ffi",
        "ffm",
        "fi",
        "fil",
        "fit",
        "fj",
        "flr",
        "fmp",
        "fo",
        "fod",
        "fon",
        "for",
        "fpe",
        "fqs",
        "fr",
        "frc",
        "frp",
        "frr",
        "frs",
        "fud",
        "fue",
        "fuf",
        "fuh",
        "fuq",
        "fur",
        "fuv",
        "fuy",
        "fvr",
        "fy",
        "ga",
        "gaa",
        "gaf",
        "gag",
        "gah",
        "gaj",
        "gam",
        "gaw",
        "gay",
        "gba",
        "gbf",
        "gby",
        "gcr",
        "gd",
        "gde",
        "gdn",
        "gdr",
        "geb",
        "gej",
        "gel",
        "gfk",
        "ghs",
        "gil",
        "gim",
        "gjn",
        "gkn",
        "gkp",
        "gl",
        "gmm",
        "gn",
        "gnd",
        "gng",
        "god",
        "goi",
        "gor",
        "gos",
        "grb",
        "grw",
        "gsw",
        "gub",
        "guc",
        "gud",
        "gur",
        "guw",
        "gux",
        "guz",
        "gv",
        "gvf",
        "gvs",
        "gwi",
        "gyi",
        "ha",
        "hag",
        "ham",
        "haw",
        "hbb",
        "hhy",
        "hi-Latn",
        "hia",
        "hif",
        "hig",
        "hih",
        "hil",
        "hla",
        "hmt",
        "hnn",
        "ho",
        "hot",
        "hr",
        "hsb",
        "ht",
        "hu",
        "hui",
        "hz",
        "ia",
        "ian",
        "iar",
        "iba",
        "ibb",
        "iby",
        "ica",
        "ich",
        "id",
        "idd",
        "idi",
        "idu",
        "ife",
        "ig",
        "igb",
        "ige",
        "ijj",
        "ik",
        "ikk",
        "ikt",
        "ikw",
        "ikx",
        "ilo",
        "imo",
        "in",
        "io",
        "iou",
        "iri",
        "is",
        "it",
        "iwm",
        "iws",
        "izh",
        "izi",
        "jab",
        "jam",
        "jbo",
        "jbu",
        "jen",
        "jgk",
        "jgo",
        "jib",
        "jmc",
        "jra",
        "jut",
        "jv",
        "jw",
        "kab",
        "kac",
        "kad",
        "kai",
        "kaj",
        "kam",
        "kao",
        "kbm",
        "kbp",
        "kbq",
        "kbx",
        "kcg",
        "kck",
        "kcl",
        "kct",
        "kde",
        "kdl",
        "kea",
        "ken",
        "kez",
        "kfo",
        "kg",
        "kge",
        "kgf",
        "kgp",
        "kha",
        "khq",
        "khs",
        "khz",
        "ki",
        "kij",
        "kiu",
        "kiw",
        "kj",
        "kjd",
        "kjs",
        "kjy",
        "kkc",
        "kkj",
        "kl",
        "kln",
        "klq",
        "klt",
        "klx",
        "kmb",
        "kmh",
        "kmo",
        "kms",
        "kmu",
        "kmw",
        "knf",
        "knp",
        "kol",
        "kos",
        "koz",
        "kpe",
        "kpf",
        "kpo",
        "kpr",
        "kpx",
        "kqb",
        "kqf",
        "kqs",
        "kr",
        "kri",
        "krj",
        "krl",
        "krs",
        "ksb",
        "ksd",
        "ksf",
        "ksh",
        "ksj",
        "ksr",
        "ktm",
        "kto",
        "ktr",
        "ku",
        "kub",
        "kud",
        "kue",
        "kuj",
        "kun",
        "kup",
        "kus",
        "kvg",
        "kvr",
        "kw",
        "kwj",
        "kwo",
        "kwq",
        "kxa",
        "kxe",
        "kxw",
        "kxz",
        "ky-Latn",
        "ky-TR",
        "kye",
        "kyx",
        "kzj",
        "kzr",
        "kzt",
        "la",
        "lag",
        "laj",
        "las",
        "lb",
        "lbu",
        "lbw",
        "lcm",
        "ldb",
        "led",
        "lee",
        "lem",
        "leq",
        "leu",
        "lg",
        "lgg",
        "li",
        "lia",
        "lid",
        "lig",
        "lih",
        "lij",
        "ljp",
        "lkt",
        "lle",
        "lln",
        "lmo",
        "lmp",
        "ln",
        "lns",
        "lnu",
        "loj",
        "lok",
        "lol",
        "lor",
        "los",
        "loz",
        "lt",
        "ltg",
        "lu",
        "lua",
        "luo",
        "luy",
        "lv",
        "lzz",
        "mad",
        "maf",
        "mak",
        "man",
        "mas",
        "maw",
        "maz",
        "mbh",
        "mbo",
        "mbq",
        "mbu",
        "mbw",
        "mci",
        "mcp",
        "mcq",
        "mcr",
        "mcu",
        "mda",
        "mdh",
        "mdj",
        "mdr",
        "med",
        "mee",
        "mek",
        "men",
        "mer",
        "met",
        "meu",
        "mfe",
        "mfn",
        "mfo",
        "mfq",
        "mg",
        "mgh",
        "mgl",
        "mgo",
        "mgy",
        "mh",
        "mhi",
        "mhl",
        "mi",
        "mif",
        "min",
        "miw",
        "mkl",
        "mkp",
        "mkw",
        "mle",
        "mlp",
        "mls",
        "mmo",
        "mmu",
        "mmx",
        "mna",
        "mnf",
        "mo",
        "moa",
        "moe",
        "moh",
        "mos",
        "mox",
        "mpp",
        "mps",
        "mpt",
        "mpx",
        "mql",
        "ms",
        "ms-ID",
        "mt",
        "mtc",
        "mtf",
        "mti",
        "mua",
        "mur",
        "mus",
        "mva",
        "mvn",
        "mwk",
        "mwv",
        "mxc",
        "mxm",
        "myk",
        "myw",
        "myx",
        "mzk",
        "mzm",
        "mzp",
        "mzw",
        "mzz",
        "na",
        "nac",
        "naf",
        "nak",
        "nap",
        "naq",
        "nas",
        "nb",
        "nca",
        "nce",
        "ncf",
        "nch",
        "nco",
        "ncu",
        "nd",
        "ndc",
        "nds",
        "neb",
        "nex",
        "nfr",
        "ng",
        "nga",
        "ngb",
        "ngl",
        "nhb",
        "nhe",
        "nhw",
        "nif",
        "nii",
        "nij",
        "nin",
        "niu",
        "niy",
        "niz",
        "njo",
        "nkg",
        "nko",
        "nl",
        "nmg",
        "nmz",
        "nn",
        "nnf",
        "nnh",
        "nnk",
        "nnm",
        "no",
        "nop",
        "nou",
        "nr",
        "nrb",
        "nsn",
        "nso",
        "nss",
        "ntm",
        "ntr",
        "nui",
        "nup",
        "nus",
        "nuv",
        "nux",
        "nv",
        "nwb",
        "nxq",
        "nxr",
        "ny",
        "nym",
        "nyn",
        "nzi",
        "oc",
        "ogc",
        "okr",
        "okv",
        "om",
        "ong",
        "onn",
        "ons",
        "opm",
        "oro",
        "ozm",
        "pag",
        "pam",
        "pap",
        "pau",
        "pbi",
        "pcd",
        "pcm",
        "pdc",
        "pdt",
        "ped",
        "pex",
        "pfl",
        "pil",
        "pip",
        "pko",
        "pl",
        "pla",
        "pms",
        "png",
        "pnn",
        "pon",
        "ppo",
        "prg",
        "pss",
        "pt",
        "ptp",
        "puu",
        "pwa",
        "qu",
        "quc",
        "qug",
        "rai",
        "rao",
        "rcf",
        "rej",
        "rel",
        "res",
        "rgn",
        "ria",
        "rif-NL",
        "rm",
        "rmf",
        "rmo",
        "rmu",
        "rn",
        "rna",
        "rng",
        "ro",
        "rob",
        "rof",
        "roo",
        "rro",
        "rtm",
        "rug",
        "rw",
        "rwk",
        "rwo",
        "saf",
        "saq",
        "sas",
        "sav",
        "sba",
        "sbe",
        "sbp",
        "sc",
        "scn",
        "sco",
        "scs",
        "sdc",
        "se",
        "sef",
        "seh",
        "sei",
        "ses",
        "sg",
        "sgs",
        "sgz",
        "shk",
        "sid",
        "sig",
        "sil",
        "sim",
        "sjr",
        "sk",
        "skc",
        "sks",
        "sl",
        "sld",
        "sli",
        "sll",
        "sly",
        "sm",
        "sma",
        "smj",
        "smn",
        "smq",
        "sms",
        "sn",
        "snc",
        "snk",
        "snp",
        "snx",
        "sny",
        "so",
        "sok",
        "soq",
        "soy",
        "spd",
        "spl",
        "sps",
        "sq",
        "sr-ME",
        "sr-RO",
        "sr-RU",
        "sr-TR",
        "srn",
        "srr",
        "ss",
        "ssd",
        "ssg",
        "ssy",
        "st",
        "stk",
        "stq",
        "su",
        "sua",
        "sue",
        "suk",
        "sur",
        "sus",
        "sv",
        "sw",
        "swc",
        "swg",
        "swp",
        "sxn",
        "sxw",
        "szl",
        "tal",
        "tan",
        "taq",
        "tbc",
        "tbd",
        "tbf",
        "tbg",
        "tbo",
        "tbw",
        "tbz",
        "tci",
        "tdu",
        "ted",
        "tem",
        "teo",
        "tet",
        "tfi",
        "tgc",
        "tgo",
        "tgu",
        "tif",
        "tik",
        "tim",
        "tio",
        "tiv",
        "tk",
        "tkl",
        "tkr",
        "tl",
        "tlf",
        "tlx",
        "tly",
        "tmh",
        "tmy",
        "tn",
        "tnh",
        "to",
        "tof",
        "tog",
        "toq",
        "tpi",
        "tpm",
        "tpz",
        "tqo",
        "tr",
        "tru",
        "trv",
        "ts",
        "tsg",
        "tsw",
        "ttd",
        "tte",
        "ttj",
        "ttr",
        "ttt",
        "tuh",
        "tul",
        "tum",
        "tuq",
        "tvd",
        "tvl",
        "tvu",
        "twh",
        "twq",
        "ty",
        "tya",
        "tzm",
        "ubu",
        "uli",
        "umb",
        "und",
        "uok",
        "uri",
        "urt",
        "urw",
        "usa",
        "utr",
        "uvh",
        "uvl",
        "uz",
        "vag",
        "van",
        "ve",
        "vec",
        "vep",
        "vi",
        "vic",
        "viv",
        "vls",
        "vmf",
        "vmw",
        "vo",
        "vot",
        "vro",
        "vun",
        "vut",
        "wa",
        "wae",
        "waj",
        "wan",
        "war",
        "wbp",
        "wci",
        "wer",
        "wgi",
        "whg",
        "wib",
        "wiu",
        "wiv",
        "wja",
        "wji",
        "wls",
        "wmo",
        "wnc",
        "wnu",
        "wo",
        "wob",
        "wos",
        "wrs",
        "wsk",
        "wuv",
        "wwa",
        "xav",
        "xbi",
        "xes",
        "xh",
        "xla",
        "xog",
        "xon",
        "xrb",
        "xsi",
        "xsm",
        "xwe",
        "yam",
        "yao",
        "yap",
        "yas",
        "yat",
        "yav",
        "yay",
        "yaz",
        "yba",
        "ybb",
        "yby",
        "yer",
        "ygr",
        "ygw",
        "yko",
        "yle",
        "ylg",
        "yll",
        "yml",
        "yo",
        "yon",
        "yrb",
        "yre",
        "yrl",
        "yss",
        "yua",
        "yuj",
        "yut",
        "yuw",
        "za",
        "zag",
        "zea",
        "zia",
        "zlm",
        "zmi",
        "zne",
        "zu",
        "zza",
    ]
    keywords = [
        "noise",
        "rule-based",
        "written",
        "visual",
        "highly-meaning-preserving",
        "high-precision",
        "high-coverage",
        "high-generations",
    ]

    def __init__(self, seed=664, max_outputs=1):
        nltkdl("stopwords")
        nltkdl("punkt")
        super().__init__(seed, max_outputs=max_outputs)

        # Mapping tables based on unicode-formatter (MIT license)
        # https://github.com/DenverCoder1/unicode-formatter

        dict_path = os.path.join(
            os.path.dirname(os.path.abspath(__file__)), "fonts.json"
        )
        with open(dict_path) as f:
            self.fonts = json.load(f)

    def generate(self, sentence: str):
        perturbed_texts = font_change(
            sentence,
            self.fonts,
            seed=self.seed,
            max_outputs=self.max_outputs,
        )
        return perturbed_texts
